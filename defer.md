
## ä¸€å¥è¯å…ˆç»™é¢è¯•å®˜ ğŸ‘‡

> **`defer` ç”¨äºå»¶è¿Ÿå‡½æ•°æ‰§è¡Œï¼Œé€šå¸¸ç”¨æ¥åšèµ„æºé‡Šæ”¾ã€çŠ¶æ€å›æ»šå’Œå…œåº•æ¸…ç†ï¼Œç¡®ä¿å‡½æ•°é€€å‡ºæ—¶ä¸€å®šä¼šæ‰§è¡Œã€‚**

---

## ä¸€ã€defer çš„æ ¸å¿ƒä½œç”¨ï¼ˆä¸ºä»€ä¹ˆè¦æœ‰å®ƒï¼‰

### 1ï¸âƒ£ èµ„æºé‡Šæ”¾ï¼ˆæœ€å¸¸è§ï¼‰

```go
file, _ := os.Open("a.txt")
defer file.Close()
```

é€‚ç”¨åœºæ™¯ï¼š

* æ–‡ä»¶
* ç½‘ç»œè¿æ¥
* é”
* æ•°æ®åº“äº‹åŠ¡

ğŸ‘‰ **ä¼˜ç‚¹**ï¼š
ä¸ç”¨åœ¨æ¯ä¸ª return åˆ†æ”¯æ‰‹åŠ¨æ¸…ç†ï¼Œ**é˜²æ­¢èµ„æºæ³„æ¼**

---

### 2ï¸âƒ£ é”çš„å®‰å…¨é‡Šæ”¾

```go
mu.Lock()
defer mu.Unlock()
```

é¿å…ï¼š

* ä¸­é€” return å¿˜è®° Unlock
* panic å¯¼è‡´æ­»é”

---

### 3ï¸âƒ£ çŠ¶æ€å›æ»š / å…œåº•é€»è¾‘

```go
defer recoverPanic()
```

* panic å…œåº•
* äº‹åŠ¡ rollback
* æŒ‡æ ‡ä¸ŠæŠ¥

---

### 4ï¸âƒ£ ä»£ç å¯è¯»æ€§æ›´å¥½

```go
open()
defer close()
```

ğŸ‘‰ **â€œå…ˆç”³è¯·ï¼Œåå£°æ˜é‡Šæ”¾â€**
ç¬¦åˆäººç±»é˜…è¯»é¡ºåº

---

## äºŒã€defer çš„æ‰§è¡Œè§„åˆ™ï¼ˆå¿…è€ƒï¼‰

### 1ï¸âƒ£ æ‰§è¡Œæ—¶æœº

> **å‡½æ•°è¿”å›ä¹‹å‰æ‰§è¡Œ**

åŒ…æ‹¬ï¼š

* `return`
* `panic`
* æ­£å¸¸ç»“æŸ

---

### 2ï¸âƒ£ æ‰§è¡Œé¡ºåºï¼ˆLIFOï¼‰

```go
defer fmt.Println(1)
defer fmt.Println(2)
defer fmt.Println(3)
```

è¾“å‡ºï¼š

```text
3
2
1
```

ğŸ‘‰ **æ ˆç»“æ„**

---

### 3ï¸âƒ£ defer å‚æ•°çš„æ±‚å€¼æ—¶æœºï¼ˆè¶…çº§é«˜é¢‘å‘ï¼‰

â—**å‚æ•°åœ¨ defer å£°æ˜æ—¶å°±å·²ç»ç¡®å®š**

```go
x := 10
defer fmt.Println(x)
x = 20
```

è¾“å‡ºï¼š

```text
10
```

---

### 4ï¸âƒ£ defer å¯ä»¥ä¿®æ”¹è¿”å›å€¼ï¼ˆé«˜çº§ï¼‰

```go
func f() (x int) {
    defer func() {
        x++
    }()
    return 1
}
```

è¿”å›ï¼š

```text
2
```

ğŸ‘‰ å› ä¸ºï¼š

* return å…ˆèµ‹å€¼
* defer åæ‰§è¡Œ

---

## ä¸‰ã€defer åœ¨ panic / recover ä¸­çš„ä½œç”¨

### recover åªèƒ½åœ¨ defer ä¸­ç”Ÿæ•ˆ

```go
defer func() {
    if err := recover(); err != nil {
        fmt.Println("recover:", err)
    }
}()
```

âŒ ä¸‹é¢è¿™æ ·æ— æ•ˆï¼š

```go
recover() // æ²¡ç”¨
```

---

## å››ã€å¸¸è§ defer å‘ï¼ˆé¢è¯•é‡ç‚¹ï¼‰

### âŒ 1ï¸âƒ£ for å¾ªç¯é‡Œ deferï¼ˆç»å…¸ç¿»è½¦ï¼‰

```go
for i := 0; i < 3; i++ {
    defer fmt.Println(i)
}
```

è¾“å‡ºï¼š

```text
2
1
0
```

âš ï¸ è€Œä¸” **æ‰€æœ‰ defer éƒ½å †åœ¨ä¸€èµ·ï¼Œå¯èƒ½å ç”¨å¤§é‡å†…å­˜**

---

### âŒ 2ï¸âƒ£ defer + é—­åŒ…å˜é‡æ•è·

```go
for i := 0; i < 3; i++ {
    defer func() {
        fmt.Println(i)
    }()
}
```

è¾“å‡ºï¼š

```text
3
3
3
```

âœ… æ­£ç¡®æ–¹å¼ï¼š

```go
for i := 0; i < 3; i++ {
    i := i
    defer func() {
        fmt.Println(i)
    }()
}
```

---

### âŒ 3ï¸âƒ£ defer çš„æ€§èƒ½é—®é¢˜

* defer ä¸æ˜¯é›¶æˆæœ¬
* åœ¨é«˜é¢‘ã€çŸ­å‡½æ•°ã€å¾ªç¯ä¸­æ…ç”¨

Go 1.14+ å·²ä¼˜åŒ–å¾ˆå¤šï¼Œä½†**ä¸æ˜¯å…è´¹**

---

## äº”ã€ä»€ä¹ˆæ—¶å€™è¯¥ç”¨ / ä¸è¯¥ç”¨ defer

### âœ… é€‚åˆç”¨ defer

* èµ„æºé‡Šæ”¾
* é”é‡Šæ”¾
* panic å…œåº•
* å•æ¬¡å‡½æ•°è°ƒç”¨

### âŒ è°¨æ…ç”¨ defer

* çƒ­è·¯å¾„
* for å¾ªç¯
* æç«¯æ€§èƒ½æ•æ„Ÿä»£ç 

---

## å…­ã€é¢è¯•å®˜â€œé«˜åˆ†æ¨¡æ¿å›ç­”â€ï¼ˆå¯ç›´æ¥èƒŒï¼‰

> `defer` ä¸»è¦ç”¨äºå»¶è¿Ÿæ‰§è¡Œæ¸…ç†é€»è¾‘ï¼Œç¡®ä¿å‡½æ•°é€€å‡ºæ—¶èµ„æºä¸€å®šè¢«é‡Šæ”¾ã€‚
> å®ƒçš„æ‰§è¡Œé¡ºåºæ˜¯ LIFOï¼Œå‚æ•°åœ¨ defer å£°æ˜æ—¶å°±å·²ç»æ±‚å€¼ã€‚
> defer åœ¨ panic æ—¶ä¹Ÿä¼šæ‰§è¡Œï¼Œå› æ­¤å¸¸ç”¨äº recoverã€‚
> ä½† defer æœ‰ä¸€å®šæ€§èƒ½å¼€é”€ï¼Œåœ¨é«˜é¢‘å¾ªç¯ä¸­éœ€è¦è°¨æ…ä½¿ç”¨ã€‚
