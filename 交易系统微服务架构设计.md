**生产级交易系统微服务架构设计**（偏撮合型交易所 / 金融交易系统），包含：

* 高并发撮合
* 资金安全隔离
* 最终一致
* 可横向扩展
* 可观测性完备

分为：

1. 总体架构图
2. 核心服务拆分
3. 核心链路（下单 → 撮合 → 成交 → 清算）
4. 技术栈建议
5. 高可用 & 风控设计
6. 数据一致性设计

---

# 一、总体架构设计图

```
                        ┌─────────────────────┐
                        │       Client        │
                        │  Web / App / API    │
                        └──────────┬──────────┘
                                   │
                         ┌─────────▼──────────┐
                         │     API Gateway    │
                         │  Auth / RateLimit  │
                         └─────────┬──────────┘
                                   │
        ┌──────────────────────────┼──────────────────────────┐
        │                          │                          │
        ▼                          ▼                          ▼
 ┌──────────────┐          ┌──────────────┐           ┌──────────────┐
 │  User Svc    │          │  Order Svc   │           │ Wallet Svc   │
 └──────┬───────┘          └──────┬───────┘           └──────┬───────┘
        │                         │                           │
        │                         ▼                           │
        │                ┌────────────────┐                   │
        │                │ Matching Engine│                   │
        │                └──────┬─────────┘                   │
        │                       │                             │
        │                       ▼                             ▼
        │                 ┌───────────┐                 ┌──────────┐
        │                 │  Trade MQ │                 │  Redis   │
        │                 └──────┬────┘                 └──────────┘
        │                        │
        ▼                        ▼
 ┌──────────────┐         ┌──────────────┐
 │ Settlement   │         │ Risk Engine  │
 │ 清算服务     │         │ 风控服务     │
 └──────┬───────┘         └──────────────┘
        │
        ▼
 ┌──────────────┐
 │ MySQL / CDC  │
 └──────────────┘

监控：Prometheus
日志：ELK
链路追踪：Jaeger
容器编排：Kubernetes
```

涉及核心组件：

* **Kubernetes**
* **Redis**
* **MySQL**
* **Apache Kafka**
* **Prometheus**
* **Jaeger**

---

# 二、核心服务拆分

## 1️⃣ API Gateway

职责：

* JWT 鉴权
* 限流
* 黑名单
* 请求路由
* TraceID 注入

建议：

* Go + Gin
* 或 Nginx + 内部微服务

---

## 2️⃣ Order Service（订单服务）

职责：

* 接收下单请求
* 参数校验
* 生成订单ID
* 写入 Redis 预存
* 投递撮合请求到 MQ

关键点：

* 不直接写 MySQL（性能瓶颈）
* 异步落库

---

## 3️⃣ Matching Engine（撮合引擎）

核心：

* 单线程 / 多 Symbol 分区
* 内存 OrderBook
* 价格优先 + 时间优先
* O(log n) 结构（红黑树/跳表）

设计原则：

* 极致低延迟
* 不做持久化
* 只做撮合

通常使用：

* 单机多实例（按交易对分片）
* 内存撮合 + 事件流输出

---

## 4️⃣ Trade MQ

撮合成功后：

* 发送成交事件
* Order 状态更新
* 钱包变更通知

推荐使用：

* **Apache Kafka**

原因：

* 高吞吐
* 分区模型适合按 symbol 分片

---

## 5️⃣ Wallet Service（钱包服务）

职责：

* 冻结余额
* 扣减
* 增加
* 保证资金强一致

设计：

* 资金变更必须幂等
* 必须有账本表（Ledger）

---

## 6️⃣ Settlement Service（清算）

作用：

* 处理成交后资金划转
* 生成账本记录
* 触发风控检查

---

## 7️⃣ Risk Engine（风控引擎）

职责：

* 杠杆检查
* 爆仓检查
* 强平触发
* 持仓监控

可单独服务，实时订阅成交流。

---

# 三、核心链路流程（下单流程）

### Step1：用户下单

Client → Gateway → Order Svc

---

### Step2：订单冻结资金

OrderSvc → WalletSvc

* 扣除可用余额
* 增加冻结余额

---

### Step3：发送撮合请求

OrderSvc → Kafka → Matching Engine

---

### Step4：撮合成功

Matching Engine：

* 内存撮合
* 生成 Trade
* 推送 Trade 事件

---

### Step5：清算

Settlement：

* 更新买卖双方余额
* 更新订单状态
* 写账本

---

# 四、高可用设计

## 1️⃣ 撮合引擎如何高可用？

策略：

* 按 symbol 分区
* 主从热备
* 事件流可重放（Kafka replay）

撮合数据来源：

* 订单事件流重建 OrderBook

---

## 2️⃣ 如何防止资金错账？

必须：

* 每笔资金变更写 Ledger
* 全链路幂等
* 使用唯一业务ID

公式：

```
期初余额 + 所有账本变动 = 当前余额
```

---

# 五、数据一致性方案

交易系统必须避免分布式事务。

推荐模型：

### ✅ 事件驱动 + 最终一致

* 下单写 Redis
* 成交发 Kafka
* 清算异步更新数据库
* 使用 Outbox 模式

---

# 六、核心数据库设计

### 表设计示例

order

```
id
uid
symbol
price
amount
status
```

trade

```
id
buy_order_id
sell_order_id
price
amount
```

ledger

```
id
uid
asset
delta
type
biz_id
```

---

# 七、性能瓶颈分析

| 模块    | 瓶颈   |
| ----- | ---- |
| MySQL | 写入过多 |
| 撮合    | 锁竞争  |
| MQ    | 分区不足 |
| Redis | 单点   |

优化：

* 分库分表
* Symbol 分片
* Kafka 多分区
* Redis Cluster

---

# 八、可观测性设计

必须接入：

* **Prometheus**
* **Grafana**
* **Jaeger**

关键监控指标：

* 撮合 TPS
* 成交延迟
* MQ Lag
* 钱包变更失败率
* 强平触发数

---

# 九、企业级增强设计

* 灰度发布（K8s）
* 限价熔断
* 防止插针攻击
* 内存撮合落盘快照
* 定期状态对账

---

# 十、总结一句话

交易系统微服务架构核心是：

> 撮合内存化 + 事件驱动 + 资金强一致 + 服务分层解耦 + 全链路可观测
