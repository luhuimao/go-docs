

## ä¸€ã€Channel æ˜¯ç”¨æ¥å¹²å˜›çš„ï¼Ÿ

ä¸€å¥è¯ç‰ˆæœ¬ï¼š

> **Channel æ˜¯ goroutine ä¹‹é—´å®‰å…¨é€šä¿¡å’ŒåŒæ­¥çš„å·¥å…·**

Go çš„å¹¶å‘å“²å­¦æ˜¯ï¼š

> **Do not communicate by sharing memory; share memory by communicating.**

ä¹Ÿå°±æ˜¯è¯´ï¼š

* ä¸æ¨èå¤šä¸ª goroutine ç›´æ¥æ“ä½œåŒä¸€å—å†…å­˜ï¼ˆé”åœ°ç‹±ï¼‰
* è€Œæ˜¯ **é€šè¿‡ channel ä¼ é€’æ•°æ®**
* channel å¤©ç”Ÿ **çº¿ç¨‹å®‰å…¨**

---

## äºŒã€Channel åœ¨ Go å¹¶å‘æ¨¡å‹ä¸­çš„è§’è‰²

Go å¹¶å‘ä¸‰ä»¶å¥—ï¼š

| ç»„ä»¶        | ä½œç”¨             |
| --------- | -------------- |
| goroutine | å¹¶å‘æ‰§è¡Œå•å…ƒ         |
| channel   | goroutine ä¹‹é—´é€šä¿¡ |
| select    | å¤šè·¯ channel è°ƒåº¦  |

ğŸ‘‰ **channel æ˜¯ goroutine çš„â€œç®¡é“â€**

---

## ä¸‰ã€Channel çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ

### 1ï¸âƒ£ ç±»å‹å®‰å…¨çš„é˜Ÿåˆ—

```go
ch := make(chan int)
```

æœ¬è´¨ä¸Šï¼š

* ä¸€ä¸ª **FIFO é˜Ÿåˆ—**
* é˜Ÿåˆ—å…ƒç´ ç±»å‹å›ºå®šï¼ˆ`int` / struct / pointerï¼‰
* å†…éƒ¨ç”± runtime ç®¡ç†ï¼ˆé” + ç­‰å¾…é˜Ÿåˆ—ï¼‰

---

### 2ï¸âƒ£ Channel åŒæ—¶æ‰¿æ‹…ä¸¤ç§èŒè´£

#### âœ… æ•°æ®ä¼ é€’

```go
ch <- 1      // å‘é€
x := <-ch   // æ¥æ”¶
```

#### âœ… åŒæ­¥ï¼ˆé˜»å¡ï¼‰

* å‘é€å¯èƒ½é˜»å¡
* æ¥æ”¶å¯èƒ½é˜»å¡
* æ‰€ä»¥ **channel == æ•°æ® + åŒæ­¥åŸè¯­**

è¿™ç‚¹éå¸¸é‡è¦ï¼Œå¾ˆå¤šäººåªçœ‹åˆ°â€œä¼ å€¼â€ï¼Œå¿½ç•¥äº†â€œåŒæ­¥â€ã€‚

---

## å››ã€Channel çš„åˆ†ç±»ï¼ˆé‡ç‚¹ï¼‰

### 1ï¸âƒ£ æ— ç¼“å†² Channelï¼ˆUnbufferedï¼‰

```go
ch := make(chan int)
```

ç‰¹ç‚¹ï¼š

* **å‘é€å’Œæ¥æ”¶å¿…é¡»åŒæ—¶å‘ç”Ÿ**
* å¦åˆ™ç›´æ¥é˜»å¡

```go
ch <- 1   // é˜»å¡ï¼Œç›´åˆ°æœ‰äººæ¥æ”¶
```

ğŸ“Œ è¡Œä¸ºæ¨¡å‹ï¼š**åŒæ­¥é€šä¿¡ï¼ˆrendezvousï¼‰**

#### é€‚ç”¨åœºæ™¯

* ç²¾ç¡®åŒæ­¥
* å¼ºé¡ºåºä¿è¯
* ç±»ä¼¼â€œä¿¡å·é‡ + æ•°æ®â€

---

### 2ï¸âƒ£ æœ‰ç¼“å†² Channelï¼ˆBufferedï¼‰

```go
ch := make(chan int, 3)
```

ç‰¹ç‚¹ï¼š

* å†…éƒ¨æœ‰ä¸€ä¸ªç¼“å†²é˜Ÿåˆ—
* é˜Ÿåˆ—æ²¡æ»¡ â†’ å‘é€ä¸é˜»å¡
* é˜Ÿåˆ—ä¸ºç©º â†’ æ¥æ”¶é˜»å¡

```go
ch <- 1 // ä¸é˜»å¡ï¼ˆæœªæ»¡ï¼‰
```

ğŸ“Œ è¡Œä¸ºæ¨¡å‹ï¼š**å¼‚æ­¥é€šä¿¡**

#### é€‚ç”¨åœºæ™¯

* å‰Šå³°
* producer / consumer
* æé«˜åå

---

## äº”ã€Channel çš„é˜»å¡è¯­ä¹‰ï¼ˆå¿…è€ƒï¼‰

### å‘é€é˜»å¡æ¡ä»¶

| ç±»å‹  | ä»€ä¹ˆæ—¶å€™é˜»å¡   |
| --- | -------- |
| æ— ç¼“å†² | æ²¡æœ‰æ¥æ”¶è€…    |
| æœ‰ç¼“å†² | buffer æ»¡ |

---

### æ¥æ”¶é˜»å¡æ¡ä»¶

| æƒ…å†µ  | æ˜¯å¦é˜»å¡      |
| --- | --------- |
| æ— ç¼“å†² | æ²¡æœ‰å‘é€è€…     |
| æœ‰ç¼“å†² | buffer ä¸ºç©º |

---

## å…­ã€Channel å’Œ Close çš„è¯­ä¹‰ï¼ˆé«˜é¢‘é¢è¯•ç‚¹ï¼‰

### 1ï¸âƒ£ close(channel) åšäº†ä»€ä¹ˆï¼Ÿ

```go
close(ch)
```

**å¹¶ä¸æ˜¯é”€æ¯ channel**ï¼Œè€Œæ˜¯ï¼š

* æ ‡è®° channel ä¸º **å…³é—­çŠ¶æ€**
* ä¸å…è®¸å†å‘é€
* æ¥æ”¶æ–¹è¿˜èƒ½ç»§ç»­è¯» **å·²å­˜åœ¨çš„æ•°æ®**

---

### 2ï¸âƒ£ å‘å·²å…³é—­ channel å‘é€ï¼Ÿ

```go
ch <- 1 // panic!
```

ğŸ‘‰ **ç›´æ¥ panic**

---

### 3ï¸âƒ£ ä»å…³é—­çš„ channel æ¥æ”¶ï¼Ÿ

```go
v, ok := <-ch
```

* `ok == false` è¡¨ç¤º channel å·²å…³é—­ä¸”æ— æ•°æ®
* `v` æ˜¯é›¶å€¼

ğŸ“Œ **for-range ä¼šè‡ªåŠ¨æ„ŸçŸ¥ close**

```go
for v := range ch {
    fmt.Println(v)
}
```

---

### 4ï¸âƒ£ è°æ¥ close channelï¼Ÿ

**ç»éªŒæ³•åˆ™ï¼ˆé¢è¯•å¿…èƒŒï¼‰**ï¼š

> **å‘é€æ–¹å…³é—­ channelï¼Œè€Œä¸æ˜¯æ¥æ”¶æ–¹**

åŸå› ï¼š

* åªæœ‰å‘é€æ–¹çŸ¥é“â€œæ•°æ®æ˜¯å¦å‘å®Œâ€
* æ¥æ”¶æ–¹ close å¯èƒ½å¯¼è‡´ panic

---

## ä¸ƒã€Channel çš„æ–¹å‘é™åˆ¶ï¼ˆé«˜çº§ç”¨æ³•ï¼‰

```go
chan int        // åŒå‘
chan<- int     // åªå†™
<-chan int     // åªè¯»
```

### ç”¨é€”

* **API çº¦æŸ**
* é˜²æ­¢è¯¯ç”¨
* æé«˜å¯è¯»æ€§

```go
func producer(ch chan<- int) {
    ch <- 1
}
```

---

## å…«ã€Channel vs Mutexï¼ˆç»å¸¸è¢«é—®ï¼‰

| å¯¹æ¯”é¡¹  | Channel    | Mutex |
| ---- | ---------- | ----- |
| æŠ½è±¡å±‚çº§ | é«˜          | ä½     |
| è¡¨è¾¾åŠ›  | å¼ºï¼ˆæ•°æ® + åŒæ­¥ï¼‰ | åªåŒæ­¥   |
| æ€§èƒ½   | ç¨ä½         | æ›´å¿«    |
| å¯è¯»æ€§  | æ›´å¥½         | æ˜“å‡ºé”™   |
| é€‚åˆåœºæ™¯ | æµæ°´çº¿ã€æ¶ˆæ¯     | ä¸´ç•ŒåŒº   |

ğŸ‘‰ **ç»“è®º**ï¼š

* å¤æ‚å¹¶å‘é€»è¾‘ â†’ channel
* é«˜é¢‘å…±äº«è®¡æ•° â†’ mutex

---

## ä¹ã€Channel + Selectï¼ˆå¹¶å‘è°ƒåº¦æ ¸å¿ƒï¼‰

```go
select {
case v := <-ch1:
    ...
case ch2 <- x:
    ...
default:
    ...
}
```

ä½œç”¨ï¼š

* å¤š channel ç›‘å¬
* é¿å…æ­»é”
* å®ç°è¶…æ—¶ / éé˜»å¡

```go
select {
case v := <-ch:
    fmt.Println(v)
case <-time.After(time.Second):
    fmt.Println("timeout")
}
```

---

## åã€Channel å¸¸è§å‘ï¼ˆçœŸå®è¸©é›·ï¼‰

### âŒ å¿˜è®° closeï¼Œå¯¼è‡´ goroutine æ³„æ¼

```go
for v := range ch {
    ...
}
```

ch æ°¸è¿œä¸ close â†’ æ°¸è¿œé˜»å¡

---

### âŒ ç¼“å†² channel å½“é˜Ÿåˆ—ä¹±ç”¨

```go
ch := make(chan int, 100000)
```

* å å†…å­˜
* ä¸ç­‰äºæ— é™é˜Ÿåˆ—
* èƒŒå‹å¤±æ•ˆ

---

### âŒ å¤šä¸ª sender ä¹± close

```go
close(ch) // panic é£é™©æé«˜
```

ğŸ‘‰ éœ€è¦ **å•ä¸€å…³é—­è€…**

---

## åä¸€ã€Channel çš„ç»å…¸ä½¿ç”¨æ¨¡å¼

### 1ï¸âƒ£ Worker Pool

```go
jobs := make(chan Job)
results := make(chan Result)
```

---

### 2ï¸âƒ£ Fan-out / Fan-in

```go
å¤šä¸ª goroutine è¯»åŒä¸€ä¸ª channel
```

---

### 3ï¸âƒ£ Pipeline

```go
ch1 -> ch2 -> ch3
```

---

### 4ï¸âƒ£ Done / Cancel æ¨¡å¼

```go
select {
case <-done:
    return
default:
}
```
